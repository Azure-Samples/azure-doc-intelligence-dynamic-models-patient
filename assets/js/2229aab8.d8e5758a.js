"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[763],{4137:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=a.createContext({}),s=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=s(e.components);return a.createElement(p.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,p=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=s(n),d=i,h=u["".concat(p,".").concat(d)]||u[d]||m[d]||r;return n?a.createElement(h,o(o({ref:t},c),{},{components:n})):a.createElement(h,o({ref:t},c))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=d;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[u]="string"==typeof e?e:i,o[1]=l;for(var s=2;s<r;s++)o[s]=n[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5597:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>m,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var a=n(7462),i=(n(7294),n(4137));const r={},o="Integrate Azure AI Document Intelligence",l={unversionedId:"create-new-patient-app/integrate-ai",id:"create-new-patient-app/integrate-ai",title:"Integrate Azure AI Document Intelligence",description:"In this section, we're going to be updating an Azure Function to call Document Intelligence to extract the patient's information from the uploaded image.",source:"@site/docs/30-create-new-patient-app/10-integrate-ai.md",sourceDirName:"30-create-new-patient-app",slug:"/create-new-patient-app/integrate-ai",permalink:"/Contoso-New-Patient-App/create-new-patient-app/integrate-ai",draft:!1,editUrl:"https://github.com/Contoso-New-Patient-App/tree/main/docs/docs/30-create-new-patient-app/10-integrate-ai.md",tags:[],version:"current",sidebarPosition:10,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Azure Static Web Apps",permalink:"/Contoso-New-Patient-App/create-new-patient-app/intro-static-web-apps"},next:{title:"Upload a registration form",permalink:"/Contoso-New-Patient-App/create-new-patient-app/upload-doc"}},p={},s=[{value:"Updating the Azure Function",id:"updating-the-azure-function",level:2},{value:"Running Locally",id:"running-locally",level:2},{value:"List the Azure service keys",id:"list-the-azure-service-keys",level:3},{value:"Update the local.settings.json file",id:"update-the-localsettingsjson-file",level:3},{value:"Run the application locally",id:"run-the-application-locally",level:3},{value:"Test the Application",id:"test-the-application",level:3},{value:"Deploy to Azure",id:"deploy-to-azure",level:2},{value:"Open the patient registration app in your browser",id:"open-the-patient-registration-app-in-your-browser",level:2}],c={toc:s},u="wrapper";function m(e){let{components:t,...r}=e;return(0,i.kt)(u,(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"integrate-azure-ai-document-intelligence"},"Integrate Azure AI Document Intelligence"),(0,i.kt)("p",null,"In this section, we're going to be updating an Azure Function to call Document Intelligence to extract the patient's information from the uploaded image."),(0,i.kt)("h2",{id:"updating-the-azure-function"},"Updating the Azure Function"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Switch back to VS Code, you should still have the ",(0,i.kt)("strong",{parentName:"p"},"contoso_new_patient_app")," open in VS Code.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Open the ",(0,i.kt)("strong",{parentName:"p"},"UploadFile.cs")," file, located at ",(0,i.kt)("strong",{parentName:"p"},"src/api/NewPatient/UploadFile.cs"),".")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Scroll down to the ",(0,i.kt)("strong",{parentName:"p"},"// TODO: Call Azure AI Document Intelligence")," section.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Replace the ",(0,i.kt)("strong",{parentName:"p"},"// TODO comment and throw")," statement with the following code"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},'string? endpoint = Environment.GetEnvironmentVariable("FORM_RECOGNIZER_ENDPOINT");\nstring? apiKey = Environment.GetEnvironmentVariable("FORM_RECOGNIZER_API_KEY");\nstring? modelId = Environment.GetEnvironmentVariable("FORM_RECOGNIZER_MODEL_ID");\n\nif (string.IsNullOrEmpty(endpoint) || string.IsNullOrEmpty(apiKey) || string.IsNullOrEmpty(modelId))\n{\n    throw new InvalidOperationException("Missing environment variables");\n}\n\nvar credential = new AzureKeyCredential(apiKey);\nvar client = new DocumentAnalysisClient(new Uri(endpoint), credential);\n\nAnalyzeDocumentOperation operation = await client.AnalyzeDocumentAsync(WaitUntil.Completed, modelId, file.OpenReadStream());\nAnalyzeResult result = operation.Value;\n\nvar outputs = new Dictionary<string, (string, float?)>();\n\nforeach (AnalyzedDocument document in result.Documents)\n{\n    foreach ((string fieldName, DocumentField field) in document.Fields)\n    {\n        outputs.Add(fieldName, (field.Content, field.Confidence));\n    }\n}\n\nreturn outputs;\n'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"You must ",(0,i.kt)("strong",{parentName:"p"},"Save")," the file."))),(0,i.kt)("details",null,(0,i.kt)("summary",null,"What is this code doing?"),(0,i.kt)("p",null,"Let's take some time to understand what this code is doing by breaking it down piece by piece."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},'string? endpoint = Environment.GetEnvironmentVariable("FORM_RECOGNIZER_ENDPOINT");\nstring? apiKey = Environment.GetEnvironmentVariable("FORM_RECOGNIZER_API_KEY");\nstring? modelId = Environment.GetEnvironmentVariable("FORM_RECOGNIZER_MODEL_ID");\n\nif (string.IsNullOrEmpty(endpoint) || string.IsNullOrEmpty(apiKey) || string.IsNullOrEmpty(modelId))\n{\n    throw new InvalidOperationException("Missing environment variables");\n}\n')),(0,i.kt)("p",null,"This first piece of code is retrieving the environment variables that contain the keys and other secret information for Azure AI Document Intelligence, avoiding us from hard-coding them into the code. We've also got some ",(0,i.kt)("inlineCode",{parentName:"p"},"null")," checking, to ensure that we have set the values."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"var credential = new AzureKeyCredential(apiKey);\nvar client = new DocumentAnalysisClient(new Uri(endpoint), credential);\n")),(0,i.kt)("p",null,"Here, we're creating the connection to Document Intelligence using the endpoint and API key."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"AnalyzeDocumentOperation operation = await client.AnalyzeDocumentAsync(WaitUntil.Completed, modelId, file.OpenReadStream());\nAnalyzeResult result = operation.Value;\n\nvar outputs = new Dictionary<string, (string, float?)>();\n\nforeach (AnalyzedDocument document in result.Documents)\n{\n    foreach ((string fieldName, DocumentField field) in document.Fields)\n    {\n        outputs.Add(fieldName, (field.Content, field.Confidence));\n    }\n}\n\nreturn outputs;\n")),(0,i.kt)("p",null,"Lastly, we'll call Azure AI Document Intelligence, telling it which image we want to analyze and what trained model to use for that. When the result comes back, we'll loop through the fields that were found and return them as a dictionary, which will later be stored in Cosmos DB.")),(0,i.kt)("details",null,(0,i.kt)("summary",null,"Optional. Run the patient Static Web App locally."),(0,i.kt)("h2",{id:"running-locally"},"Running Locally"),(0,i.kt)("p",null,"To run the application locally, we need to set the environment variables for the Azure Function in the ",(0,i.kt)("strong",{parentName:"p"},"local.settings.json")," file."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Create a new file (if one doesn't already exist) at ",(0,i.kt)("strong",{parentName:"p"},"src/api/local.settings.json")," and include the following code:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "IsEncrypted": false,\n    "Values": {\n      "AzureWebJobsSecretStorageType": "files",\n      "FUNCTIONS_WORKER_RUNTIME": "dotnet",          \n      "COSMOS_DB": "REPLACE_WITH_COSMOS_DB_CONNECTION_STRING",\n      "FORM_RECOGNIZER_API_KEY": "REPLACE_WITH_FORM_RECOGNIZER_API_KEY",\n      "FORM_RECOGNIZER_ENDPOINT": "REPLACE_WITH_FORM_RECOGNIZER_ENDPOINT",\n      "NEW_PATIENT_STORAGE": "REPLACE_WITH_STORAGE_CONNECTION_STRING",\n      "FORM_RECOGNIZER_MODEL_ID": "patient-registration-model"\n    },\n    "Host": {\n      "CORS": "*"\n    }\n}\n')))),(0,i.kt)("h3",{id:"list-the-azure-service-keys"},"List the Azure service keys"),(0,i.kt)("p",null,"You will need the Azure service keys to configure the patient registration app. So, from the terminal window, run the following commands to list the Azure service keys."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Run the following command to list Azure service keys."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"azd env get-values\n")))),(0,i.kt)("h3",{id:"update-the-localsettingsjson-file"},"Update the local.settings.json file"),(0,i.kt)("p",null,"Replace the placeholders with the values from the ",(0,i.kt)("inlineCode",{parentName:"p"},"azd env get-values")," command."),(0,i.kt)("p",null,"Once all the environment variables have been set, you can run the application locally."),(0,i.kt)("h3",{id:"run-the-application-locally"},"Run the application locally"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Open the ",(0,i.kt)("strong",{parentName:"p"},"Run and Debug")," view from the VS Code sidebar, or select ",(0,i.kt)("kbd",null,"Ctrl+Shift+D")," or ",(0,i.kt)("kbd",null,"Cmd+Shift+D")," on macOS."),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("img",{alt:"The image shows how to launch the Run and Debug view",src:n(5118).Z,width:"484",height:"480"}))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"From the drop down, select ",(0,i.kt)("strong",{parentName:"p"},"launch: all"),", then select the ",(0,i.kt)("em",{parentName:"p"},"Start Debugging")," button."),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("img",{alt:"The image shows how to select launch all",src:n(9445).Z,width:"391",height:"234"})),(0,i.kt)("admonition",{parentName:"li",type:"info"},(0,i.kt)("p",{parentName:"admonition"},"Depending on how fast your computer is, it may take up to 30 seconds for the Static Web App to start."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Once all the debuggers have started, navigate to ",(0,i.kt)("a",{parentName:"p",href:"http://localhost:4280"},"http://localhost:4280")," in your web browser."))),(0,i.kt)("h3",{id:"test-the-application"},"Test the Application"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Drag and drop one of the training images from the ",(0,i.kt)("inlineCode",{parentName:"p"},"contoso_new_patient_assets/training_labeled/<language>")," folder into the drop zone. Be sure to use an image from the folder that matches the language you used to train the Document Intelligence model.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Next, select ",(0,i.kt)("strong",{parentName:"p"},"Upload"),".")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Once the image has been uploaded, and after a few seconds, you'll see the fields that were extracted from the form.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Select ",(0,i.kt)("strong",{parentName:"p"},"Save")," to save the data to Patient Registration Cosmos DB.")))),(0,i.kt)("h2",{id:"deploy-to-azure"},"Deploy to Azure"),(0,i.kt)("p",null,"Deploy the app to Azure Static Web Apps with the Azure Developer CLI."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"From VS Code, select ",(0,i.kt)("kbd",null,"Ctrl+Shift+`")," to open a new terminal.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"From the terminal, run the following command to start the function app. This command takes about one minute to deploy the updated function to Azure."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"azd deploy\n")))),(0,i.kt)("h2",{id:"open-the-patient-registration-app-in-your-browser"},"Open the patient registration app in your browser"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"From your browser, open the patient registration app at the ",(0,i.kt)("strong",{parentName:"p"},"Web Service")," URL displayed in the deployment logs."),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("img",{src:n(1782).Z,width:"964",height:"265"}))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Save the patient registration app URL for use in the next section."))))}m.isMDXComponent=!0},1782:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/select-web-service-url-b96bde9d715284cafe29c9d9b24fe41a.png"},9445:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/launch-60e3275ba1ee245e4a8957d3ad02f3f0.png"},5118:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/run-8f5595d1cc67308bd0d29df241134fec.png"}}]);